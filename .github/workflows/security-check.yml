name: Security Alerts to Issues

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

permissions:
  security-events: read
  issues: write

jobs:
  check-alerts:
    runs-on: ubuntu-latest
    steps:
      - name: Create Issues from Security Alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const severityToPriority = {
              'critical': 'P0-Critical',
              'high': 'P1-High',
              'medium': 'P2-Medium',
              'low': 'P3-Low'
            };

            const existingIssues = await github.rest.issues.listForRepo({
              owner, repo,
              labels: 'security',
              state: 'all',
              per_page: 100
            });
            const existingTitles = existingIssues.data.map(i => i.title);
            console.log('Existing security issues: ' + existingTitles.length);

            let created = 0;

            try {
              const alerts = await github.rest.dependabot.listAlertsForRepo({
                owner, repo, state: 'open'
              });
              console.log('Open Dependabot alerts: ' + alerts.data.length);

              for (const alert of alerts.data) {
                const pkg = alert.dependency?.package?.name || 'Unknown';
                const sev = alert.security_advisory?.severity?.toLowerCase() || 'medium';
                const sum = alert.security_advisory?.summary || 'No summary';
                const priority = severityToPriority[sev] || 'P2-Medium';

                const title = '[SECURITY] ' + pkg + ': ' + sum.substring(0, 50);

                if (existingTitles.some(t => t.includes(pkg) && t.includes('[SECURITY]'))) {
                  console.log('Skip ' + pkg + ' - exists');
                  continue;
                }

                const body = [
                  '## Dependabot Alert',
                  '',
                  '**Package**: ' + pkg,
                  '**Severity**: ' + sev.toUpperCase(),
                  '**Summary**: ' + sum,
                  '',
                  '**CVE**: ' + (alert.security_advisory?.cve_id || 'N/A'),
                  '',
                  '### Action Required',
                  '- [ ] Update package',
                  '- [ ] Verify fix',
                  '',
                  '[View Alert](' + alert.html_url + ')'
                ].join('\n');

                try {
                  const issue = await github.rest.issues.create({
                    owner, repo, title, body,
                    labels: ['security', priority, 'dependabot']
                  });
                  console.log('Created issue #' + issue.data.number);
                  created++;
                } catch (e) {
                  console.log('Failed: ' + e.message);
                }
              }
            } catch (e) {
              console.log('Dependabot error: ' + e.message);
            }

            console.log('Total issues created: ' + created);
