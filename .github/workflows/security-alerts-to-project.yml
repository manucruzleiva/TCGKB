name: Security Alerts to Project

# Trigger on security-related events
on:
  # Dependabot alerts
  dependabot_alert:
    types: [created]

  # Code scanning alerts (CodeQL)
  code_scanning_alert:
    types: [created, reopened]

  # Secret scanning alerts
  secret_scanning_alert:
    types: [created]

  # Also run on schedule to catch any missed alerts
  schedule:
    - cron: '0 8 * * *'  # Daily at 8am UTC

  # Manual trigger
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  PROJECT_NUMBER: 2
  OWNER: manucruzleiva

jobs:
  # Handle Dependabot alerts
  dependabot-alert:
    if: github.event_name == 'dependabot_alert'
    runs-on: ubuntu-latest
    steps:
      - name: Create Project Item for Dependabot Alert
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const alert = context.payload.alert;
            const severity = alert.security_advisory?.severity?.toUpperCase() || 'UNKNOWN';
            const package_name = alert.dependency?.package?.name || 'Unknown package';
            const summary = alert.security_advisory?.summary || 'No summary';

            // Map severity to priority label
            const priorityMap = {
              'CRITICAL': 'P0-Critical',
              'HIGH': 'P1-High',
              'MEDIUM': 'P2-Medium',
              'LOW': 'P3-Low'
            };
            const priority = priorityMap[severity] || 'P1-High';

            const title = `[SECURITY] [${severity}] ${package_name}: ${summary.substring(0, 80)}`;
            const body = `## Security Alert - Dependabot

            **Severity**: ${severity}
            **Package**: ${package_name}
            **Summary**: ${summary}

            **CVE**: ${alert.security_advisory?.cve_id || 'N/A'}
            **GHSA**: ${alert.security_advisory?.ghsa_id || 'N/A'}

            ### Action Required
            - [ ] Review vulnerability details
            - [ ] Update package to patched version
            - [ ] Verify fix doesn't break functionality
            - [ ] @bob security review
            - [ ] @raj implement fix

            ### Links
            - [Alert Details](${alert.html_url})
            - [Advisory](${alert.security_advisory?.permalink || 'N/A'})

            ---
            *Auto-generated by security-alerts-to-project workflow*`;

            // Create issue first
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', priority, 'dependabot']
            });

            console.log(`Created issue #${issue.data.number}`);

  # Handle Code Scanning (CodeQL) alerts
  code-scanning-alert:
    if: github.event_name == 'code_scanning_alert'
    runs-on: ubuntu-latest
    steps:
      - name: Create Project Item for CodeQL Alert
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const alert = context.payload.alert;
            const severity = alert.rule?.severity?.toUpperCase() || 'WARNING';
            const rule_id = alert.rule?.id || 'unknown-rule';
            const description = alert.rule?.description || 'No description';
            const file_path = alert.most_recent_instance?.location?.path || 'Unknown file';
            const line = alert.most_recent_instance?.location?.start_line || '?';

            // Map severity
            const priorityMap = {
              'ERROR': 'P0-Critical',
              'WARNING': 'P1-High',
              'NOTE': 'P2-Medium'
            };
            const priority = priorityMap[severity] || 'P1-High';

            const title = `[SECURITY] [CodeQL] ${rule_id}: ${description.substring(0, 60)}`;
            const body = `## Security Alert - Code Scanning (CodeQL)

            **Rule**: ${rule_id}
            **Severity**: ${severity}
            **Description**: ${description}

            ### Location
            - **File**: \`${file_path}:${line}\`

            ### Action Required
            - [ ] Review code at specified location
            - [ ] Fix vulnerability
            - [ ] @bob verify fix
            - [ ] @raj implement fix

            ### Links
            - [Alert Details](${alert.html_url})

            ---
            *Auto-generated by security-alerts-to-project workflow*`;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', priority, 'codeql']
            });

            console.log(`Created issue #${issue.data.number}`);

  # Handle Secret Scanning alerts
  secret-scanning-alert:
    if: github.event_name == 'secret_scanning_alert'
    runs-on: ubuntu-latest
    steps:
      - name: Create Project Item for Secret Alert
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const alert = context.payload.alert;
            const secret_type = alert.secret_type_display_name || alert.secret_type || 'Unknown';

            const title = `[SECURITY] [CRITICAL] Exposed Secret: ${secret_type}`;
            const body = `## Security Alert - Secret Scanning

            **Type**: ${secret_type}
            **Status**: CRITICAL - Immediate action required

            ### IMMEDIATE ACTIONS REQUIRED
            1. **REVOKE** the exposed secret immediately
            2. **ROTATE** credentials in all environments
            3. **AUDIT** for unauthorized access
            4. **UPDATE** the secret in Vercel/production

            ### Checklist
            - [ ] Secret revoked at source
            - [ ] New secret generated
            - [ ] Vercel env vars updated
            - [ ] Local .env updated
            - [ ] @bob security audit
            - [ ] Verify no unauthorized access occurred

            ### Links
            - [Alert Details](${alert.html_url})

            ---
            *Auto-generated by security-alerts-to-project workflow*

            **THIS IS A P0 CRITICAL ISSUE - DROP EVERYTHING AND FIX**`;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'P0-Critical', 'secret-exposed']
            });

            console.log(`Created issue #${issue.data.number}`);

  # Daily sync to catch any missed alerts
  daily-sync:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Check for open alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            console.log('Checking for open security alerts...');

            // Check Dependabot alerts
            try {
              const dependabotAlerts = await github.rest.dependabot.listAlertsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });
              console.log(`Found ${dependabotAlerts.data.length} open Dependabot alerts`);

              // Log summary
              for (const alert of dependabotAlerts.data) {
                console.log(`- ${alert.dependency.package.name}: ${alert.security_advisory.severity}`);
              }
            } catch (e) {
              console.log('Could not fetch Dependabot alerts:', e.message);
            }

            // Check code scanning alerts
            try {
              const codeAlerts = await github.rest.codeScanning.listAlertsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });
              console.log(`Found ${codeAlerts.data.length} open Code Scanning alerts`);
            } catch (e) {
              console.log('Could not fetch Code Scanning alerts:', e.message);
            }

            console.log('Daily security check complete.');
